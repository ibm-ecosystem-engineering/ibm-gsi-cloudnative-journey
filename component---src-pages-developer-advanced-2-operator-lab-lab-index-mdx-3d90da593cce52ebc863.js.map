{"version":3,"sources":["webpack:///./src/pages/developer-advanced-2/operator-lab/lab/index.mdx"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"mappings":"mfAOO,IAAMA,EAAe,GAOtBC,EAAc,CAClBD,gBAEIE,EAAYC,IACH,SAASC,EAAT,GAGZ,IAFDC,EAEC,EAFDA,WACGC,E,oIACF,mBACD,OAAO,YAACJ,EAAD,KAAeD,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYE,QAAQ,cAI5E,qHACA,sDACA,sBACE,kBAAIC,WAAW,MAAf,iCACA,kBAAIA,WAAW,MAAf,+BACA,kBAAIA,WAAW,MAAf,oCAEF,qDAAoC,mBAAGA,WAAW,KAAQ,CACtD,KAAQ,gEADwB,gEAGpC,0DACA,qEACA,uCACA,sBACE,kBAAIA,WAAW,MAAf,YACA,kBAAIA,WAAW,MAAf,oDACA,kBAAIA,WAAW,MAAf,qCACA,kBAAIA,WAAW,MAAf,oDACA,kBAAIA,WAAW,MAAf,oCAEF,mCACA,oEACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,qCAEL,0EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,+BAEL,+EACA,qLACA,uDACA,wHACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,uJAOL,iKACA,wCACA,sLACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,mEAEL,qDACA,0EACA,sBACE,kBAAIA,WAAW,MAAf,yCACA,kBAAIA,WAAW,MAAf,yFAEF,mFACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,8EAEL,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,yEAEL,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,uEAEL,8FACA,gKACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,2GAEL,+GACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,gHAEL,oDACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,wKAKL,2EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,4BAEL,8CACA,wEACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,qEAEL,4FACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,4BAEL,+EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,sBAEL,+BACA,waAEA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,2cAKL,oFACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,iRASL,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,0LAIL,8FACA,yBAAQ,qBAAKA,WAAW,KAAQ,CAC5B,IAAO,wBACP,IAAO,YAEX,iDACA,6HACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,+HAIL,+EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,4BAEL,8EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,yBAEL,2EACA,sBACE,kBAAIA,WAAW,MAAf,mDAEF,kBAAS,CACP,IAAO,4BACP,IAAO,UAET,kBAAS,CACP,IAAO,4BACP,IAAO,UAET,sBACE,kBAAIA,WAAW,MAAf,2DAEF,kBAAS,CACP,IAAO,4BACP,IAAO,UAET,2KACA,iDACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,uSAOL,iDACA,+EACA,sBACE,kBAAIA,WAAW,MAAf,qDACA,kBAAIA,WAAW,MAAf,gBACA,kBAAIA,WAAW,MAAf,yCACA,kBAAIA,WAAW,MAAf,4BAEF,oGACA,yEACA,sBACE,kBAAIA,WAAW,MAAf,2EACA,kBAAIA,WAAW,MAAf,uEACA,kBAAIA,WAAW,MAAf,uDACA,kBAAIA,WAAW,MAAf,6FACA,kBAAIA,WAAW,MAAf,6EAMNJ,EAAWK,gBAAiB","file":"component---src-pages-developer-advanced-2-operator-lab-lab-index-mdx-3d90da593cce52ebc863.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/Users/admin/Documents/ISL/Code/GSI-Labs/gatsby-sites/ibm-gsi-cloudnative-journey/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nimport Globals from 'gatsby-theme-carbon/src/templates/Globals';\nexport const _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\n\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n\n    <h2>{`Creating Helm-based Operators to install NGINX Webserver on ROKS 4.4 using the Operator SDK`}</h2>\n    <h3>{`Install the Operator SDK CLI`}</h3>\n    <ul>\n      <li parentName=\"ul\">{`Install from Homebrew (macOS)`}</li>\n      <li parentName=\"ul\">{`Install from GitHub release`}</li>\n      <li parentName=\"ul\">{`Compile and install from master`}</li>\n    </ul>\n    <p>{`Visit here for more details: `}<a parentName=\"p\" {...{\n        \"href\": \"https://sdk.operatorframework.io/docs/install-operator-sdk/\"\n      }}>{`https://sdk.operatorframework.io/docs/install-operator-sdk/`}</a></p>\n    <h3>{`Installing from Homebrew (MacOS)`}</h3>\n    <p>{`You can install the SDK CLI using Homebrew. `}</p>\n    <h3>{`Prerequisites`}</h3>\n    <ul>\n      <li parentName=\"ul\">{`Homebrew`}</li>\n      <li parentName=\"ul\">{`docker v17.03+, podman v1.2.0+, or buildah v1.7+`}</li>\n      <li parentName=\"ul\">{`OpenShift CLI (oc) 4.4+ installed`}</li>\n      <li parentName=\"ul\">{`Access to a cluster based on Kubernetes v1.12.0+`}</li>\n      <li parentName=\"ul\">{`Access to a container registry `}</li>\n    </ul>\n    <h3>{`Procedure`}</h3>\n    <p>{`Install the SDK CLI using the brew command:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ brew install operator-sdk \n`}</code></pre>\n    <p>{`Verify that the CLI tool was installed correctly:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ operator-sdk version\n`}</code></pre>\n    <h3>{`Building a Helm-based Operator using the Operator SDK`}</h3>\n    <p>{`This procedure walks through an example of building a simple Nginx Operator powered by a Helm chart using tools and libraries provided by the Operator SDK. `}</p>\n    <h4>{`Create a new Operator project`}</h4>\n    <p>{`To create a new Helm-based, namespace-scoped nginx-operator project, use the following command:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ operator-sdk new nginx-operator \\\\\n    --api-version=example.com/v1alpha1 \\\\\n    --kind=Nginx \\\\\n    --type=helm\n\n  $ cd nginx-operator\n`}</code></pre>\n    <p>{`This creates the nginx-operator project specifically for watching the Nginx resource with APIVersion example.com/v1apha1 and Kind Nginx.`}</p>\n    <h4>{`Deploy the CRD`}</h4>\n    <p>{`Before running the Operator, Kubernetes needs to know about the new custom resource definition (CRD) the operator will be watching. Deploy the following CRD:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc create -f deploy/crds/example_v1alpha1_nginx_crd.yaml\n`}</code></pre>\n    <h4>{`Build and run the Operator.`}</h4>\n    <p>{`There are two ways to build and run the Operator:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`As a Pod inside a Kubernetes cluster.`}</li>\n      <li parentName=\"ul\">{`As a Go/Helm/Ansible program outside the cluster using the operator-sdk up command. `}</li>\n    </ul>\n    <h5>{`Build the nginx-operator image and push it to a registry:`}</h5>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ operator-sdk build docker.io/$DOCKER_USERNAME/nginx-operator:v0.0.1\n`}</code></pre>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ docker login docker.io -u $DOCKER_USERNAME -p $DOCKER_PASSWORD\n`}</code></pre>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ docker push docker.io/$DOCKER_USERNAME/nginx-operator:v0.0.1\n`}</code></pre>\n    <h5>{`Deployment manifests are generated in the deploy/operator.yaml file.`}</h5>\n    <p>{`The deployment image in this file needs to be modified from the placeholder REPLACE_IMAGE to the previous built image. To do this, run:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ sed -i 's|REPLACE_IMAGE|docker.io/$DOCKER_USERNAME/nginx-operator:v0.0.1|g' deploy/operator.yaml\n`}</code></pre>\n    <p>{`Note: If you are performing these steps on OSX, use the following sed command instead:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ sed -i \"\" 's|REPLACE_IMAGE|docker.io/$DOCKER_USERNAME/nginx-operator:v0.0.1|g' deploy/operator.yaml\n`}</code></pre>\n    <h5>{`Deploy the nginx-operator:`}</h5>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc create -f deploy/service_account.yaml\n  $ oc create -f deploy/role.yaml\n  $ oc create -f deploy/role_binding.yaml\n  $ oc create -f deploy/operator.yaml\n`}</code></pre>\n    <h5>{`Verify that the nginx-operator is up and running:`}</h5>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc get deployment\n`}</code></pre>\n    <h4>{`Deploy the Nginx CR.`}</h4>\n    <p>{`  Apply the Nginx CR that you modified earlier:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc apply -f deploy/crds/example.com_v1alpha1_nginx_cr.yaml\n`}</code></pre>\n    <p>{`  Ensure that the nginx-operator creates the Deployment for the CR:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc get deployment\n`}</code></pre>\n    <p>{`  Check the Pods to confirm two replicas were created:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc get pods\n`}</code></pre>\n    <h4>{`Note:`}</h4>\n    <p>{`The result is actually a failure. Well, that is frustrating - helm install reported that the chart was deployed. From a helm perspective I think this is fair since it did its job and the objects have been created in the environment, however, the pod was unable to come up.\nThis was because of the container is attempting to run as root which is naughty. We find this out by inspecting the pod logs.`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`[warn] 1#1: the \"user\" directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2\nnginx: [warn] the \"user\" directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2\n[emerg] 1#1: mkdir() \"/var/cache/nginx/client_temp\" failed (13: Permission denied)\nnginx: [emerg] mkdir() \"/var/cache/nginx/client_temp\" failed (13: Permission denied)\n`}</code></pre>\n    <p>{`Letâ€™s add the serviceaccount to the anyuid scc and proceed.`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{` oc get sa\nNAME                 SECRETS   AGE\nbuilder              2         134m\ndefault              2         134m\ndeployer             2         134m\nexample-nginx        2         72m\nmemcached-operator   2         106m\nnginx-operator       2         73m\n`}</code></pre>\n    <pre><code parentName=\"pre\" {...{}}>{`bash-5.0$ oc adm policy add-scc-to-user anyuid -z example-nginx\n\nsecuritycontextconstraints.security.openshift.io/anyuid added to: [\"system:serviceaccount:dev-op:example-nginx\"]\n`}</code></pre>\n    <p>{`Delete the pod from the OpenShift Console which will recreate the POD`}</p>\n    <p>{` `}<img parentName=\"p\" {...{\n        \"src\": \"../images/ApplyCR.png\",\n        \"alt\": \"Model\"\n      }}></img></p>\n    <h4>{`Update the replicaCount`}</h4>\n    <p>{`Change the spec.replicaCount field from 2 to 3, remove the spec.service field, and apply the change:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ cat deploy/crds/example.com_v1alpha1_nginx_cr.yaml\n\n  $ oc apply -f deploy/crds/example.com_v1alpha1_nginx_cr.yaml\n`}</code></pre>\n    <p>{`Confirm that the Operator changes the Deployment size:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc get deployment\n`}</code></pre>\n    <p>{`Check that the Service port is set to the default 80:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc get service\n`}</code></pre>\n    <h4>{`Create Route for the service & Access via browser`}</h4>\n    <ul>\n      <li parentName=\"ul\">{`Create the Route for the example nginx service`}</li>\n    </ul>\n    <img {...{\n      \"src\": \"../images/RouteCreate.png\",\n      \"alt\": \"Model\"\n    }}></img>\n    <img {...{\n      \"src\": \"../images/RouteAccess.png\",\n      \"alt\": \"Model\"\n    }}></img>\n    <ul>\n      <li parentName=\"ul\">{`Access the route url from the browser for verification`}</li>\n    </ul>\n    <img {...{\n      \"src\": \"../images/NginxAccess.png\",\n      \"alt\": \"Model\"\n    }}></img>\n    <p>{`This demonstrates how you use operator sdk to develop the helm based operator for the nginx web server which is successfully installed and working`}</p>\n    <h4>{`Clean up the resources:`}</h4>\n    <pre><code parentName=\"pre\" {...{}}>{`  $ oc delete -f deploy/crds/example.com_v1alpha1_nginx_cr.yaml\n  $ oc delete -f deploy/operator.yaml\n  $ oc delete -f deploy/role_binding.yaml\n  $ oc delete -f deploy/role.yaml\n  $ oc delete -f deploy/service_account.yaml\n  $ oc delete -f deploy/crds/example_v1alpha1_nginx_crd.yaml\n`}</code></pre>\n    <h2>{`Write your own operator`}</h2>\n    <p>{`To write your own operator you can use existing tools:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`KUDO (Kubernetes Universal Declarative Operator),`}</li>\n      <li parentName=\"ul\">{`kubebuilder,`}</li>\n      <li parentName=\"ul\">{`Metacontroller using custom WebHooks,`}</li>\n      <li parentName=\"ul\">{`the Operator Framework.`}</li>\n    </ul>\n    <p>{`The Operator SDK provides the following workflow to develop a new Operator:`}</p>\n    <p>{`The following workflow is for a new Go operator:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`Create a new operator project using the SDK Command Line Interface(CLI)`}</li>\n      <li parentName=\"ul\">{`Define new resource APIs by adding Custom Resource Definitions(CRD)`}</li>\n      <li parentName=\"ul\">{`Define Controllers to watch and reconcile resources`}</li>\n      <li parentName=\"ul\">{`Write the reconciling logic for your Controller using the SDK and controller-runtime APIs`}</li>\n      <li parentName=\"ul\">{`Use the SDK CLI to build and generate the operator deployment manifests`}</li>\n    </ul>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}