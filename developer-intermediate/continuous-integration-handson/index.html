<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lab for continuous integration using tekton"><meta name=author content="Ecosystem Engineering"><link href=https://ibm-ecosystem-lab.github.io/developer-intermediate/continuous-integration-handson/ rel=canonical><link rel=icon href=../../images/cloudnativetoolkit.png><meta name=generator content="mkdocs-1.2.1, mkdocs-material-7.1.8"><title>Tekton Lab - TechZone Automation - Cloud-Native Learning Journey</title><link rel=stylesheet href=../../assets/stylesheets/main.ca7ac06f.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.f1a3b89f.min.css><meta name=theme-color content=#000000><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400,400i,700%7CIBM+Plex+Mono&display=fallback"><style>:root{--md-text-font-family:"IBM Plex Sans";--md-code-font-family:"IBM Plex Mono"}</style><link rel=stylesheet href=../../css/extra.css><link rel=stylesheet href=../../css/toolkit-code.css><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155887541-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script><!-- Determine title --><!-- The image needs to have an absolute URL --><!-- Open graph meta tags --><meta property=og:type content=website><meta property=og:title content="TechZone Automation - Cloud-Native Learning Journey - Tekton Lab"><meta property=og:description content="This Learning Journey enables cloud operators and developers to deliver cloud-native solutions with Red Hat OpenShift in hybrid cloud environments."><meta content=https://ibm-ecosystem-lab.github.io/developer-intermediate/continuous-integration-handson/ property=og:url><meta property=og:image content=https://ibm-ecosystem-lab.github.io/assets/images/banner.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1080><meta property=og:image:height content=568></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=black data-md-color-accent> <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pre-requisites class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="TechZone Automation - Cloud-Native Learning Journey" class="md-header__button md-logo" aria-label="TechZone Automation - Cloud-Native Learning Journey" data-md-component=logo> <img src=../../images/cloudnativetoolkit.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> TechZone Automation - Cloud-Native Learning Journey </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Tekton Lab </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ibm-ecosystem-lab/ibm-gsi-cloudnative-journey/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <!-- Determine class according to configuration --> <!-- Main navigation --> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <!-- Site title --> <!--
  <label class="md-nav__title" for="__drawer">
    <a
      href="../.."
      title="TechZone Automation - Cloud-Native Learning Journey"
      class="md-nav__button md-logo"
      aria-label="TechZone Automation - Cloud-Native Learning Journey"
      data-md-component="logo"
    >
      
  <img src="../../images/cloudnativetoolkit.png" alt="logo">

    </a>
    TechZone Automation - Cloud-Native Learning Journey
  </label>
--> <!-- Repository information --> <div class=md-nav__source> <a href=https://github.com/ibm-ecosystem-lab/ibm-gsi-cloudnative-journey/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> </div> </a> </div> <!-- Render item list --> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Introduction <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Introduction data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/introduction/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../getting-started/prereqs/ class=md-nav__link> Prerequisites </a> </li> <li class=md-nav__item> <a href=../../getting-started/checksetup/ class=md-nav__link> Validate Environment </a> </li> <li class=md-nav__item> <a href=../../getting-started/devenvsetup/ class=md-nav__link> Developer Tools Setup </a> </li> <li class=md-nav__item> <a href=../../getting-started/cli/ class=md-nav__link> Developer Tools CLI </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Developer Foundation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Developer Foundation" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Developer Foundation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../developer-foundation/agenda/ class=md-nav__link> Agenda </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/cloud-native-overview/ class=md-nav__link> What is Cloud-Native? </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/cloud-native-app-dev/ class=md-nav__link> Cloud-Native App Dev </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/containers/ class=md-nav__link> Containers Overview </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-overview/ class=md-nav__link> Kubernetes 'overview' </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/openshift/ class=md-nav__link> Openshift 'overview' </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-core-concepts/ class=md-nav__link> Core Concepts </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-multi-container-pods/ class=md-nav__link> Multi-Container Pods </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-observability/k8s-observability/ class=md-nav__link> Observability </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-pod-design/ class=md-nav__link> Pod Design </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-services-networking/ class=md-nav__link> Services & Networking </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-state-persistence/ class=md-nav__link> State Persistence </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/k8s-troubleshooting/ class=md-nav__link> Troubleshoot </a> </li> <li class=md-nav__item> <a href=../../developer-foundation/garage-development/ class=md-nav__link> Garage Method </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Developer Intermediate <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Developer Intermediate" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Developer Intermediate </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../agenda/ class=md-nav__link> Agenda </a> </li> <li class=md-nav__item> <a href=../deploy-app/ class=md-nav__link> Deploy First App </a> </li> <li class=md-nav__item> <a href=../artifact-management/ class=md-nav__link> Artifact Management </a> </li> <li class=md-nav__item> <a href=../code-analysis/ class=md-nav__link> Code Analysis </a> </li> <li class=md-nav__item> <a href=../continuous-delivery/ class=md-nav__link> Continuous Delivery </a> </li> <li class=md-nav__item> <a href=../content-overview/ class=md-nav__link> DevSecOps Overview </a> </li> <li class=md-nav__item> <a href=../continuous-integration/ class=md-nav__link> Continuous Integration </a> </li> <li class=md-nav__item> <a href=../image-registry/ class=md-nav__link> Image Registry </a> </li> <li class=md-nav__item> <a href=../log-management/ class=md-nav__link> Log Management </a> </li> <li class=md-nav__item> <a href=../monitoring/ class=md-nav__link> Monitoring </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_11 type=checkbox id=__nav_3_11> <label class=md-nav__link for=__nav_3_11> Inventory App <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Inventory App" data-md-level=2> <label class=md-nav__title for=__nav_3_11> <span class="md-nav__icon md-icon"></span> Inventory App </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../inventory-application/ class=md-nav__link> Intro </a> </li> <li class=md-nav__item> <a href=../inventory-prebuilt-solution/ class=md-nav__link> Solution </a> </li> <li class=md-nav__item> <a href=../inventory-service/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../inventory-bff/ class=md-nav__link> BFF </a> </li> <li class=md-nav__item> <a href=../inventory-ui/ class=md-nav__link> UI </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Developer Advanced <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Developer Advanced" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Developer Advanced </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../developer-advanced-1/inventory-cd/ class=md-nav__link> CD for Inventory App </a> </li> <li class=md-nav__item> <a href=../../developer-advanced-1/database-with-cloudant/ class=md-nav__link> Database with Cloudant </a> </li> <li class=md-nav__item> <a href=../../developer-advanced-1/database-with-mongodb/ class=md-nav__link> Database with MongoDB </a> </li> <li class=md-nav__item> <a href=../../developer-advanced-1/inventory-appid/ class=md-nav__link> Authentication with AppID </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#pre-requisites class=md-nav__link> Pre-requisites </a> </li> <li class=md-nav__item> <a href=#setup class=md-nav__link> SetUp </a> <nav class=md-nav aria-label=SetUp> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tekton-cli-installation class=md-nav__link> Tekton CLI Installation </a> </li> <li class=md-nav__item> <a href=#tekton-pipelines-installation class=md-nav__link> Tekton Pipelines Installation </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-target-namespace class=md-nav__link> Create Target Namespace </a> </li> <li class=md-nav__item> <a href=#pipeline-resources class=md-nav__link> Pipeline Resources </a> <nav class=md-nav aria-label="Pipeline Resources"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pipeline-resource-creation class=md-nav__link> Pipeline Resource Creation </a> </li> <li class=md-nav__item> <a href=#pipeline-resources-deployment class=md-nav__link> Pipeline Resources deployment </a> </li> <li class=md-nav__item> <a href=#verify-the-deployed-resource class=md-nav__link> Verify the deployed resource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#tasks class=md-nav__link> Tasks </a> <nav class=md-nav aria-label=Tasks> <ul class=md-nav__list> <li class=md-nav__item> <a href=#task-creation class=md-nav__link> Task Creation </a> </li> <li class=md-nav__item> <a href=#task-deploy class=md-nav__link> Task Deploy </a> </li> <li class=md-nav__item> <a href=#taskrun class=md-nav__link> TaskRun </a> </li> <li class=md-nav__item> <a href=#creating-additional-tasks-and-deploying-them class=md-nav__link> Creating additional tasks and deploying them </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#pipelines class=md-nav__link> Pipelines </a> <nav class=md-nav aria-label=Pipelines> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pipeline-creation class=md-nav__link> Pipeline Creation </a> </li> <li class=md-nav__item> <a href=#pipelinerun class=md-nav__link> PipelineRun </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#deploy-application class=md-nav__link> Deploy Application </a> </li> <li class=md-nav__item> <a href=#setup_1 class=md-nav__link> SetUp </a> <nav class=md-nav aria-label=SetUp> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tekton-cli-installation_1 class=md-nav__link> Tekton CLI Installation </a> </li> <li class=md-nav__item> <a href=#tekton-pipelines-installation_1 class=md-nav__link> Tekton Pipelines Installation </a> </li> <li class=md-nav__item> <a href=#tekton-dashboard-installation-optional class=md-nav__link> Tekton Dashboard Installation (Optional) </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#create-target-namespace_1 class=md-nav__link> Create Target Namespace </a> </li> <li class=md-nav__item> <a href=#pipeline-resources_1 class=md-nav__link> Pipeline Resources </a> <nav class=md-nav aria-label="Pipeline Resources"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pipeline-resource-creation_1 class=md-nav__link> Pipeline Resource Creation </a> </li> <li class=md-nav__item> <a href=#pipeline-resources-deployment_1 class=md-nav__link> Pipeline Resources deployment </a> </li> <li class=md-nav__item> <a href=#verify-the-deployed-resource_1 class=md-nav__link> Verify the deployed resource </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#tasks_1 class=md-nav__link> Tasks </a> <nav class=md-nav aria-label=Tasks> <ul class=md-nav__list> <li class=md-nav__item> <a href=#task-creation_1 class=md-nav__link> Task Creation </a> </li> <li class=md-nav__item> <a href=#task-deploy_1 class=md-nav__link> Task Deploy </a> </li> <li class=md-nav__item> <a href=#taskrun_1 class=md-nav__link> TaskRun </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/ibm-ecosystem-lab/ibm-gsi-cloudnative-journey/edit/main/docs/developer-intermediate/continuous-integration-handson.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Tekton Lab</h1> <!--- cSpell:ignore ICPA yamls openshiftconsole Theia userid toolset crwexposeservice gradlew bluemix ocinstall Mico crwopenlink crwopenapp swaggerui gitpat gituser  buildconfig yourproject wireframe devenvsetup viewapp crwopenlink  atemplatized rtifactoryurlsetup Kata Koda configmap Katacoda checksetup cndp katacoda checksetup Linespace igccli regcred REPLACEME Tavis pipelinerun openshiftcluster invokecloudshell cloudnative sampleapp bwoolf hotspots multicloud pipelinerun Sricharan taskrun Vadapalli Rossel REPLACEME cloudnativesampleapp artifactoryuntar untar Hotspot devtoolsservices Piyum Zonooz Farr Kamal Arora Laszewski  Roadmap roadmap Istio Packt buildpacks automatable ksonnet jsonnet targetport podsiks SIGTERM SIGKILL minikube apiserver multitenant kubelet multizone Burstable checksetup handson  stockbffnode codepatterns devenvsetup newwindow preconfigured cloudantcredentials apikey Indexyaml classname  errorcondition tektonpipeline gradlew gitsecret viewapp cloudantgitpodscreen crwopenlink cdply crwopenapp --> <h2 id=pre-requisites>Pre-requisites<a class=headerlink href=#pre-requisites title="Permanent link">&para;</a></h2> <p>Make sure your environment is properly setup.</p> <p>Follow the instructions <a href=/getting-started/devenvsetup>here</a></p> <div class=tabbed-set data-tabs=1:2><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><label for=__tabbed_1_1>OpenShift</label><div class=tabbed-content> <h2 id=setup>SetUp<a class=headerlink href=#setup title="Permanent link">&para;</a></h2> <h3 id=tekton-cli-installation>Tekton CLI Installation<a class=headerlink href=#tekton-cli-installation title="Permanent link">&para;</a></h3> <ul> <li> <p><a href=https://github.com/tektoncd/cli>Tekton CLI</a> is command line utility used to interact with the Tekton resources.</p> </li> <li> <p>Follow the instructions on the tekton CLI github repository https://github.com/tektoncd/cli#installing-tkn</p> </li> <li> <p>For MacOS for example you can use brew <div class=highlight><pre><span></span><code>brew tap tektoncd/tools
brew install tektoncd/tools/tektoncd-cli
</code></pre></div></p> </li> <li>Verify the Tekton cli <div class=highlight><pre><span></span><code>tkn version
</code></pre></div></li> <li>The command should show a result like: <div class=highlight><pre><span></span><code>$ tkn version
Client version: 0.8.0
</code></pre></div></li> <li>If you already have the <code>tkn</code> install you can upgrade running <div class=highlight><pre><span></span><code>brew upgrade tektoncd/tools/tektoncd-cli
</code></pre></div></li> </ul> <h3 id=tekton-pipelines-installation>Tekton Pipelines Installation<a class=headerlink href=#tekton-pipelines-installation title="Permanent link">&para;</a></h3> <ul> <li>To deploy the Tekton pipelines: <div class=highlight><pre><span></span><code> oc apply --filename https://raw.githubusercontent.com/ibm-cloud-architecture/learning-cloudnative-101/master/static/yamls/tekton-lab/tekton-operator.yaml
</code></pre></div></li> <li><strong><em>Note</em></strong>: It will take few mins for the Tekton pipeline components to be installed, you an watch the status using the command: <div class=highlight><pre><span></span><code>oc get pods -n openshift-operators
</code></pre></div> You can use <code>Ctrl+c</code> to terminate the watch</li> <li>A successful deployment of Tekton pipelines will show the following pods: <div class=highlight><pre><span></span><code>NAME                                         READY   STATUS    RESTARTS   AGE
openshift-pipelines-operator-9cdbbb854-x9tvs   1/1     Running   0          25s
</code></pre></div></li> </ul> <h2 id=create-target-namespace>Create Target Namespace<a class=headerlink href=#create-target-namespace title="Permanent link">&para;</a></h2> <ul> <li>Set the environment variable <code>NAMESPACE</code> to <code>tekton-demo</code>, if you open a new terminal remember to set this environment again <div class=highlight><pre><span></span><code>export NAMESPACE=tekton-demo
</code></pre></div></li> <li>Create a the namespace using the variable <code>NAMESPACE</code> <div class=highlight><pre><span></span><code>oc create namespace $NAMESPACE
</code></pre></div></li> </ul> <h2 id=pipeline-resources>Pipeline Resources<a class=headerlink href=#pipeline-resources title="Permanent link">&para;</a></h2> <h3 id=pipeline-resource-creation>Pipeline Resource Creation<a class=headerlink href=#pipeline-resource-creation title="Permanent link">&para;</a></h3> <h4 id=create-a-pipelineresource-of-type-git>Create a PipelineResource of type <code>git</code><a class=headerlink href=#create-a-pipelineresource-of-type-git title="Permanent link">&para;</a></h4> <ul> <li>Create the file <strong>git.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: source
spec:
  type: git
  params:
    - name: revision
      value: master
    - name: url
      value: https://github.com/ibm-cloud-architecture/cloudnative_sample_app
</code></pre></div> Verify the file content <div class=highlight><pre><span></span><code>cat git.yaml
</code></pre></div></li> </ul> <h4 id=create-a-pipelineresource-of-type-image>Create a PipelineResource of type <code>image</code><a class=headerlink href=#create-a-pipelineresource-of-type-image title="Permanent link">&para;</a></h4> <ul> <li>Set the environment variable <code>DOCKER_USERNAME</code> to your dockerhub account, replace <code>&lt;REPLACEME&gt;</code> with your docker username, keep the quotes <div class=highlight><pre><span></span><code>export DOCKER_USERNAME=&#39;&lt;REPLACEME&gt;&#39;
</code></pre></div></li> <li>Create the file <strong>image.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: image
spec:
  type: image
  params:
    - name: url
      value: index.docker.io/$DOCKER_USERNAME/cloudnative_sample_app
</code></pre></div> Verify the file content, and make sure the <code>url</code> value is valid with your dockerhub username replaced <div class=highlight><pre><span></span><code>cat image.yaml
</code></pre></div></li> </ul> <h3 id=pipeline-resources-deployment>Pipeline Resources deployment<a class=headerlink href=#pipeline-resources-deployment title="Permanent link">&para;</a></h3> <ul> <li>Each pipeline resource has:</li> <li><strong>name</strong>: the name using which it will be referred in other places</li> <li><strong>type</strong>: the type of the pipeline resource, in this example we have two types</li> <li><strong><em>git</em></strong> - this type of resource refers to a GitHub repository</li> <li><strong><em>image</em></strong> - this type of resource is linux container image</li> <li> <p><strong>params</strong>: each type can have one or more parameters that will be used to configure the underlying type. In the above example for the git-source pipeline resource, the parameters url and revision are used to identify the GitHub repository url and revision of the sources respectively.</p> </li> <li> <p>More details on other types of pipeline resource types is available <a href=https://github.com/tektoncd/pipeline/blob/master/docs/resources.md#resource-types>here</a>.</p> </li> <li> <p>Create the pipeline resources using the command: <div class=highlight><pre><span></span><code>oc apply -f git.yaml -n $NAMESPACE
oc apply -f image.yaml -n $NAMESPACE
</code></pre></div></p> </li> </ul> <h3 id=verify-the-deployed-resource>Verify the deployed resource<a class=headerlink href=#verify-the-deployed-resource title="Permanent link">&para;</a></h3> <ul> <li> <p>Use the Tekton cli to list the created resources <div class=highlight><pre><span></span><code>tkn res ls -n $NAMESPACE
</code></pre></div></p> </li> <li> <p>The above command should list two resources as shown below: <div class=highlight><pre><span></span><code>NAME                        TYPE    DETAILS
source                      git     url: https://github.com/ibm-cloud-architecture/cloudnative_sample_app
image                       image   url: index.docker.io/yourdockerhubusername/cloudnative_sample_app
</code></pre></div> Use the command help via <code>tkn res --help</code></p> </li> <li>Use the Tekton cli to describe the git resource <div class=highlight><pre><span></span><code>tkn res describe source -n $NAMESPACE
</code></pre></div> The output should look like this: <div class=highlight><pre><span></span><code>Name:                    source
Namespace:               tekton-demo
PipelineResource Type:   git

Params
NAME       VALUE
revision   master
url        https://github.com/ibm-cloud-architecture/cloudnative_sample_app

Secret Params
No secret params
</code></pre></div></li> <li>Use the Tekton cli to describe the git resource <div class=highlight><pre><span></span><code>tkn res describe image -n $NAMESPACE
</code></pre></div> The output should look like this: <div class=highlight><pre><span></span><code>Name:                    image
Namespace:               tekton-demo
PipelineResource Type:   image

Params
NAME   VALUE
url    index.docker.io/myusername/cloudnative_sample_app

Secret Params
No secret params
</code></pre></div></li> </ul> <h2 id=tasks>Tasks<a class=headerlink href=#tasks title="Permanent link">&para;</a></h2> <h3 id=task-creation>Task Creation<a class=headerlink href=#task-creation title="Permanent link">&para;</a></h3> <ul> <li>Create the below yaml files.</li> <li>The following snippet shows what a Tekton Task YAML looks like:</li> <li> <p>Create the file <strong>test_task.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: java-test
spec:
  inputs:
    resources:
      - name: source
        type: git
    params:
      - name: maven-image
        type: string
        default: maven:3.3-jdk-8
  steps:
    - name: test
      image: $(inputs.params.maven-image)
      workingdir: $(inputs.resources.source.path)
      command: [&quot;/bin/bash&quot;]
      args:
        - -c
        - |
          set -e
          mvn test
          echo &quot;tests passed with rc=$?&quot;
      volumeMounts:
        - name: m2-repository
          mountPath: /.m2
  volumes:
    - name: m2-repository
      emptyDir: {}
</code></pre></div></p> </li> <li> <p>Each Task has the following:</p> </li> <li> <p><strong>name</strong> - the unique name using which the task can be referred</p> </li> <li><strong>inputs</strong> - the inputs to the task</li> <li><strong><em>resources</em></strong> - the pipeline resources that will be used in the task e.g. git-source</li> <li>name - the name of the input resource using which it can be referenced and bound via TaskRun</li> <li>type - the type of the input resource, typically the pipeline resource type</li> <li><strong><em>params</em></strong> - the parameters that will be used in the task steps. Each parameter has</li> <li>name - the name of the parameter</li> <li>description - the description of the parameter</li> <li> <p>default - the default value of parameter</p> </li> <li> <p><strong>Note</strong>: The <code>TaskRun</code> or <code>PipelineRun</code> could override the parameter values, if no parameter value is passed then the default value will be used.</p> </li> <li> <p><strong>outputs</strong> the pipeline resource that will end artifact of the task. In the above example the build will produce a container image artifact.</p> </li> <li><strong><em>resources</em></strong> - the pipeline resources that will be used in the task e.g. builtImage</li> <li>name - the name of the input resource using which it can be referenced and bound via TaskRun</li> <li>type - the type of the input resource, typically the pipeline resource type</li> <li><strong>steps</strong> - One or more sub-tasks that will be executed in the defined order. The step has all the attributes like a Pod spec</li> <li><strong>stepTemplate</strong> - when there is a need to have similar container configuration across all steps of a the task, we can have them defined in the stepTemplate, the task steps will inherit them implicitly in all steps. In the example above we define the resources and securityContext for all the steps</li> <li> <p><strong>volumes</strong> - the task can also mount external volumes using the volumes attribute.</p> </li> <li> <p>The parameters that were part of the spec inputs params can be used in the steps using the notation <code>$(&lt;variable-name&gt;)</code>.</p> </li> </ul> <h3 id=task-deploy>Task Deploy<a class=headerlink href=#task-deploy title="Permanent link">&para;</a></h3> <ul> <li> <p>The application test task could be created using the command: <div class=highlight><pre><span></span><code>oc apply -f test_task.yaml -n $NAMESPACE
</code></pre></div></p> </li> <li> <p>We will use the Tekton cli to inspect the created resources <div class=highlight><pre><span></span><code>tkn task ls -n $NAMESPACE
</code></pre></div></p> </li> <li> <p>The above command should list one Task as shown below: <div class=highlight><pre><span></span><code>NAME        AGE
java-test   22 seconds ago
</code></pre></div></p> </li> </ul> <h3 id=taskrun>TaskRun<a class=headerlink href=#taskrun title="Permanent link">&para;</a></h3> <ul> <li>The <a href=https://github.com/tektoncd/pipeline/blob/master/docs/taskruns.md>TaskRun</a> is used to run a specific task independently. In the following section we will run the build-app task created in the previous step</li> </ul> <h4 id=taskrun-creation>TaskRun Creation<a class=headerlink href=#taskrun-creation title="Permanent link">&para;</a></h4> <ul> <li>The following snippet shows what a Tekton TaskRun YAML looks like:</li> <li>Create the file <strong>test_taskrun.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: TaskRun
metadata:
  generateName: test-task-run-
spec:
  taskRef:
    name: java-test
  inputs:
    resources:
      - name: source
        resourceRef:
          name: source
</code></pre></div></li> <li><strong>generateName</strong> - since the TaskRun can be run many times, in order to have unique name across the TaskRun ( helpful when checking the TaskRun history) we use this generateName instead of name. When Kubernetes sees generateName it will generate unique set of characters and suffix the same to build-app-, similar to how pod names are generated</li> <li><strong>taskRef</strong> - this is used to refer to the Task by its name that will be run as part of this TaskRun. In this example we use build-app Task.</li> <li>As described in the earlier section that the Task inputs and outputs could be overridden via TaskRun.</li> <li>In this example we make the Task Run <code>spec &gt; inputs &gt; resources &gt; source</code> to refer to pipeline resource <code>source</code> via the <code>resourceRef</code>.</li> <li>The application test task(java-maven-test) could be run using the command: <div class=highlight><pre><span></span><code>oc create -n $NAMESPACE -f test_taskrun.yaml
</code></pre></div></li> <li><strong>Note</strong> - As tasks will use generated name, never use <code>oc apply -f test_taskrun.yaml</code></li> <li> <p>We will use the Tekton cli to inspect the created resources: <div class=highlight><pre><span></span><code>tkn tr ls -n $NAMESPACE
</code></pre></div> The above command should list one TaskRun as shown below: <div class=highlight><pre><span></span><code>NAME                       STARTED        DURATION   STATUS
test-task-run-q6s8c        1 minute ago   ---        Running(Pending)
</code></pre></div> <strong>Note</strong> - It will take few seconds for the TaskRun to show status as Running as it needs to download the container images.</p> </li> <li> <p>To check the logs of the Task Run using the <code>tkn</code>: <div class=highlight><pre><span></span><code>tkn tr logs -f -a -n $NAMESPACE
</code></pre></div> <strong>Note</strong> - Each task step will be run within a container of its own. The -f or -a allows to tail the logs from all the containers of the task. For more options run <code>tkn tr logs --help</code></p> </li> <li>If you see the TaskRun status as Failed or Error use the following command to check the reason for error: <div class=highlight><pre><span></span><code>tkn tr describe &lt;taskrun-name&gt; -n $NAMESPACE
</code></pre></div></li> <li>If it is successful, you will see something like below. <div class=highlight><pre><span></span><code>tkn tr ls -n $NAMESPACE
</code></pre></div> The above command should list one TaskRun as shown below: <div class=highlight><pre><span></span><code>NAME                  STARTED          DURATION     STATUS
test-task-run-q6s8c   47 seconds ago   34 seconds   Succeeded
</code></pre></div></li> </ul> <h3 id=creating-additional-tasks-and-deploying-them>Creating additional tasks and deploying them<a class=headerlink href=#creating-additional-tasks-and-deploying-them title="Permanent link">&para;</a></h3> <ul> <li>Create a Task to build a container image and push to the registry</li> <li>This task will be later used by the pipeline.</li> <li>Download the task file <a href=/yamls/tekton-lab/task-buildah.yaml>task-buildah.yaml</a> to build the image, push the image to the registry:</li> <li>Create the <code>buildah</code> Task using the file and the command: <div class=highlight><pre><span></span><code>oc apply -f task-buildah.yaml -n $NAMESPACE
</code></pre></div></li> <li>Use the Tekton cli to inspect the created resources <div class=highlight><pre><span></span><code>tkn task ls -n $NAMESPACE
</code></pre></div></li> <li> <p>The above command should list one Task as shown below: <div class=highlight><pre><span></span><code>NAME              AGE
buildah            4 seconds ago
java-test         46 minutes ago
</code></pre></div></p> </li> <li> <p>To access the docker registry, create the required secret as follows.</p> </li> <li>Create the environment variables to be use, replace with real values and include the single quotes: <div class=highlight><pre><span></span><code>export DOCKER_USERNAME=&#39;&lt;DOCKER_USERNAME&gt;&#39;
</code></pre></div> <div class=highlight><pre><span></span><code>export DOCKER_PASSWORD=&#39;&lt;DOCKER_PASSWORD&gt;&#39;
</code></pre></div> <div class=highlight><pre><span></span><code>export DOCKER_EMAIL=&#39;&lt;DOCKER_EMAIL&gt;&#39;
</code></pre></div></li> <li> <p>Run the following command to create a secret <code>regcred</code> in the namespace <code>NAMESPACE</code> <div class=highlight><pre><span></span><code>oc create secret docker-registry regcred \
  --docker-server=https://index.docker.io/v1/ \
  --docker-username=${DOCKER_USERNAME} \
  --docker-password=${DOCKER_PASSWORD} \
  --docker-email=${DOCKER_EMAIL} \
  -n ${NAMESPACE}
</code></pre></div> Before creating, replace the values as mentioned above. Note: If your docker password contains special characters in it, please enclose the password in double quotes or place an escape character before each special character.</p> </li> <li> <p>(Optional) Only if you have problems with the credentials you can recreate it, but you have to deleted first <div class=highlight><pre><span></span><code>oc delete secret regcred -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li>Before we run the Task using TaskRun let us create the Kubernetes service account and attach the needed permissions to the service account, the following Kubernetes resource defines a service account called <code>pipeline</code> in namespace <code>$NAMESPACE</code> who will have administrative role within the <code>$NAMESPACE</code> namespace.</li> <li>Create the file <strong>sa.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: pipeline
secrets:
  - name: regcred
</code></pre></div></li> <li> <p>Create sa role as follows: <div class=highlight><pre><span></span><code>oc apply -n <span class=nv>$NAMESPACE</span> -f sa.yaml
</code></pre></div></p> </li> <li> <p>Lets create a Task Run for <code>buildah</code> Task using the <code>tkn</code> CLI passing the inputs, outputs and service account <div class=highlight><pre><span></span><code>tkn task start buildah <span class=se>\</span>
  -i <span class=nv>source</span><span class=o>=</span><span class=nb>source</span> <span class=se>\</span>
  -i <span class=nv>image</span><span class=o>=</span>image <span class=se>\</span>
  -s pipeline <span class=se>\</span>
  -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The task will start and logs will start printing automatically <div class=highlight><pre><span></span><code>Taskrun started: buildah-run-vvrg2
Waiting for logs to be available...
</code></pre></div></p> </li> <li> <p>Verify the status of the Task Run <div class=highlight><pre><span></span><code>tkn tr ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> Output should look like this <div class=highlight><pre><span></span><code>NAME                  STARTED          DURATION     STATUS
buildah-run-zbsrv      2 minutes ago    1 minute     Succeeded
</code></pre></div></p> </li> <li>To clean up all Pods associated with all Task Runs, delete all the task runs resources <div class=highlight><pre><span></span><code>oc delete taskrun --all -n <span class=nv>$NAMESPACE</span>
</code></pre></div></li> <li>(Optional) Instead of starting the Task via <code>tkn task start</code> you could also use yaml TaskRun <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: TaskRun
metadata:
  generateName: buildah-task-run-
spec:
  serviceAccountName: pipeline
  taskRef:
    name: buildah
  inputs:
    resources:
      - name: source
        resourceRef:
          name: source
      - name: image
        resourceRef:
          name: image
</code></pre></div> Then create the TaskRun with <code>generateName</code> <div class=highlight><pre><span></span><code>oc create -f taskrun.yaml -n <span class=nv>$NAMESPACE</span>
</code></pre></div> Follow the logs with: <div class=highlight><pre><span></span><code>tkn tr logs -f -n $NAMESPACE
</code></pre></div></li> </ul> <h2 id=pipelines>Pipelines<a class=headerlink href=#pipelines title="Permanent link">&para;</a></h2> <h3 id=pipeline-creation>Pipeline Creation<a class=headerlink href=#pipeline-creation title="Permanent link">&para;</a></h3> <ul> <li> <p>Pipelines allows to start multiple Tasks, in parallel or in a <a href=https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#runafter>certain order</a></p> </li> <li> <p>Create the file <strong>pipeline.yaml</strong>, the Pipeline contains two Tasks <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: test-build-push
spec:
  resources:
    - name: source
      type: git
    - name: image
      type: image
  tasks:
    - name: test
      taskRef:
        name: java-test
      resources:
        inputs:
          - name: source
            resource: source
    - name: build-push
      taskRef:
        name: buildah
      runAfter: [test]
      resources:
        inputs:
          - name: source
            resource: source
          - name: image
            resource: image
</code></pre></div></p> </li> <li> <p>Pipeline defines a list of Tasks to execute in order, while also indicating if any outputs should be used as inputs of a following Task by using the from field and also indicating the order of executing (using the runAfter and from fields). The same variable substitution you used in Tasks is also available in a Pipeline.</p> </li> <li>Create the Pipeline using the command: <div class=highlight><pre><span></span><code>oc apply -f pipeline.yaml -n <span class=nv>$NAMESPACE</span>
</code></pre></div></li> <li>Use the Tekton cli to inspect the created resources <div class=highlight><pre><span></span><code>tkn pipeline ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The above command should list one Pipeline as shown below: <div class=highlight><pre><span></span><code> NAME              AGE              LAST RUN   STARTED   DURATION   STATUS
test-build-push   <span class=m>31</span> seconds ago   ---        ---       ---        ---
</code></pre></div></li> </ul> <h3 id=pipelinerun>PipelineRun<a class=headerlink href=#pipelinerun title="Permanent link">&para;</a></h3> <h4 id=pipelinerun-creation>PipelineRun Creation<a class=headerlink href=#pipelinerun-creation title="Permanent link">&para;</a></h4> <ul> <li>To execute the Tasks in the Pipeline, you must create a PipelineRun. Creation of a PipelineRun will trigger the creation of TaskRuns for each Task in your pipeline.</li> <li>Create the file <strong>pipelinerun.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: PipelineRun
metadata:
  generateName: test-build-push-run-
spec:
  serviceAccountName: pipeline
  pipelineRef:
    name: test-build-push
  serviceAccountName: pipeline
  resources:
    - name: source
      resourceRef:
        name: source
    - name: image
      resourceRef:
        name: image
</code></pre></div> <strong>serviceAccount</strong> - it is always recommended to have a service account associated with PipelineRun, which can then be used to define fine grained roles.</li> <li>Create the PipelineRun using the command: <div class=highlight><pre><span></span><code>oc create -f pipelinerun.yaml -n <span class=nv>$NAMESPACE</span>
</code></pre></div></li> <li> <p>We will use the Tekton cli to inspect the created resources <div class=highlight><pre><span></span><code>tkn pipelinerun ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li> <p>The above command should list one PipelineRun as shown below: <div class=highlight><pre><span></span><code>NAME                        STARTED         DURATION   STATUS
test-build-push-run-c7zgv   <span class=m>8</span> seconds ago   ---        Running
</code></pre></div></p> </li> <li> <p>Wait for few minutes for your pipeline to complete all the tasks. If it is successful, you will see something like below. <div class=highlight><pre><span></span><code>tkn pipeline ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> <div class=highlight><pre><span></span><code>NAME              AGE              LAST RUN                    STARTED         DURATION    STATUS
test-build-push   33 minutes ago   test-build-push-run-c7zgv   2 minutes ago   2 minutes   Succeeded
</code></pre></div></p> </li> <li> <p>Run again the pipeline ls command <div class=highlight><pre><span></span><code>tkn pipelinerun ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> <div class=highlight><pre><span></span><code>NAME                        STARTED         DURATION    STATUS
test-build-push-run-c7zgv   2 minutes ago   2 minutes   Succeeded
</code></pre></div> If it is successful, go to your container registry account and verify if you have the <code>cloudnative_sample_app</code> image pushed.</p> </li> <li> <p>(Optional) Run the pipeline again using the <code>tkn</code> CLI <div class=highlight><pre><span></span><code>tkn pipeline start test-build-push <span class=se>\</span>
  -r <span class=nv>source</span><span class=o>=</span><span class=nb>source</span> <span class=se>\</span>
  -r <span class=nv>image</span><span class=o>=</span>image <span class=se>\</span>
  -s pipeline <span class=se>\</span>
  -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li>(Optional) Re-run the pipeline using last pipelinerun values <div class=highlight><pre><span></span><code>tkn pipeline start test-build-push --last -n <span class=nv>$NAMESPACE</span>
</code></pre></div></li> </ul> <h2 id=deploy-application>Deploy Application<a class=headerlink href=#deploy-application title="Permanent link">&para;</a></h2> <ul> <li>Deploy the app as follows: <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>APP_YAML_URL</span><span class=o>=</span><span class=s1>&#39;https://raw.githubusercontent.com/ibm-cloud-architecture/cloudnative_sample_app_deploy/master/yamls/&#39;</span>
oc apply -n <span class=nv>$NAMESPACE</span> -f <span class=nv>$APP_YAML_URL</span>/deployment.yaml
oc apply -n <span class=nv>$NAMESPACE</span> -f <span class=nv>$APP_YAML_URL</span>/service.yaml
</code></pre></div></li> <li>Replace the default image with the new image you deployed using Tekton</li> <li>Replace <code>&lt;DOCKER_USERNAME&gt;</code> with your username <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>DOCKER_USERNAME</span><span class=o>=</span><span class=s1>&#39;&lt;DOCKER_USERNAME&gt;&#39;</span>
</code></pre></div></li> <li>Replace <code>&lt;SHORT_GIT_HASH&gt;</code> with the tag of the image you push to the registry, you can go the registry Web UI and verify the tag value. <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>SHORT_GIT_HASH</span><span class=o>=</span><span class=s1>&#39;&lt;SHORT_GIT_HASH&gt;&#39;</span>
</code></pre></div></li> <li>Set the environment variable <code>IMAGE_URL</code> to the new image url value sing the two previous environment variables <code>DOCKER_USERNAME</code> and <code>SHORT_GIT_HASH</code> <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>IMAGE_URL</span><span class=o>=</span>docker.io/<span class=si>${</span><span class=nv>DOCKER_USERNAME</span><span class=si>}</span>/cloudnative_sample_app:<span class=si>${</span><span class=nv>SHORT_GIT_HASH</span><span class=si>}</span>
<span class=nb>echo</span> <span class=nv>$IMAGE_URL</span>
</code></pre></div></li> <li>Replace the image on the deployment <div class=highlight><pre><span></span><code>oc <span class=nb>set</span> image <span class=se>\</span>
  deployment/cloudnativesampleapp-deployment <span class=se>\</span>
  <span class=se>\*</span><span class=o>=</span><span class=si>${</span><span class=nv>IMAGE_URL</span><span class=si>}</span> <span class=se>\</span>
  -n <span class=nv>$NAMESPACE</span> --record
</code></pre></div></li> <li>Verify the image is set <div class=highlight><pre><span></span><code>oc get deploy <span class=se>\</span>
  cloudnativesampleapp-deployment <span class=se>\</span>
  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.template.spec.containers[0].image}&#39;</span> <span class=se>\</span>
  -n <span class=nv>$NAMESPACE</span>
</code></pre></div></li> <li>Verify if the pods are running: <div class=highlight><pre><span></span><code>oc get pods -n <span class=nv>$NAMESPACE</span> -l <span class=nv>app</span><span class=o>=</span>cloudnativesampleapp-selector
</code></pre></div> <div class=highlight><pre><span></span><code>NAME                          READY   STATUS      RESTARTS   AGE
cloudnativesampleapp...       1/1     Running     0          82s
</code></pre></div></li> <li>Retrieve the service NodePort: <div class=highlight><pre><span></span><code>oc describe svc cloudnativesampleapp-service -n <span class=nv>$NAMESPACE</span> <span class=p>|</span> grep NodePort
</code></pre></div> <div class=highlight><pre><span></span><code>Type:                     NodePort
NodePort:                 http  30632/TCP
</code></pre></div> In this instance the NodePort assigned is <code>30632</code></li> <li>Get the External Public IP as follows: <div class=highlight><pre><span></span><code>crc ip
</code></pre></div> <div class=highlight><pre><span></span><code>192.168.64.30
</code></pre></div></li> <li>Now access the compose the URL of the App using IP and NodePort <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>APP_EXTERNAL_IP</span><span class=o>=</span><span class=k>$(</span>crc ip<span class=k>)</span>
<span class=nb>export</span> <span class=nv>APP_NODEPORT</span><span class=o>=</span><span class=k>$(</span>oc get svc cloudnativesampleapp-service -n <span class=nv>$NAMESPACE</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[0].nodePort}&#39;</span><span class=k>)</span>
<span class=nb>export</span> <span class=nv>APP_URL</span><span class=o>=</span><span class=s2>&quot;http://</span><span class=si>${</span><span class=nv>APP_EXTERNAL_IP</span><span class=si>}</span><span class=s2>:</span><span class=si>${</span><span class=nv>APP_NODEPORT</span><span class=si>}</span><span class=s2>/greeting?name=Carlos&quot;</span>
<span class=nb>echo</span> <span class=nv>$APP_URL</span>
</code></pre></div> <div class=highlight><pre><span></span><code>http://192.168.64.30:30632//greeting?name=Carlos
</code></pre></div></li> <li>Now access the app from terminal or browser <div class=highlight><pre><span></span><code>curl <span class=nv>$APP_URL</span>
</code></pre></div> <div class=highlight><pre><span></span><code>open <span class=nv>$APP_URL</span>
</code></pre></div></li> </ul> </div> <input id=__tabbed_1_2 name=__tabbed_1 type=radio><label for=__tabbed_1_2>IKS</label><div class=tabbed-content> <h2 id=setup_1>SetUp<a class=headerlink href=#setup_1 title="Permanent link">&para;</a></h2> <h3 id=tekton-cli-installation_1>Tekton CLI Installation<a class=headerlink href=#tekton-cli-installation_1 title="Permanent link">&para;</a></h3> <ul> <li> <p><a href=https://github.com/tektoncd/cli>Tekton CLI</a> is command line utility used to interact with the Tekton resources.</p> </li> <li> <p>Follow the instructions on the tekton CLI github repository https://github.com/tektoncd/cli#installing-tkn</p> </li> <li> <p>For MacOS for example you can use brew <div class=highlight><pre><span></span><code>brew tap tektoncd/tools
brew install tektoncd/tools/tektoncd-cli
</code></pre></div></p> </li> <li>Verify the Tekton cli <div class=highlight><pre><span></span><code>tkn version
</code></pre></div></li> <li>The command should show a result like: <div class=highlight><pre><span></span><code>$ tkn version
Client version: <span class=m>0</span>.8.0
</code></pre></div></li> <li>If you already have the <code>tkn</code> install you can upgrade running <div class=highlight><pre><span></span><code>brew upgrade tektoncd/tools/tektoncd-cli
</code></pre></div></li> </ul> <h3 id=tekton-pipelines-installation_1>Tekton Pipelines Installation<a class=headerlink href=#tekton-pipelines-installation_1 title="Permanent link">&para;</a></h3> <ul> <li>To deploy the Tekton pipelines: <div class=highlight><pre><span></span><code>kubectl apply --filename https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
</code></pre></div></li> <li><strong><em>Note</em></strong>: It will take few mins for the Tekton pipeline components to be installed, you an watch the status using the command: <div class=highlight><pre><span></span><code>kubectl get pods -n tekton-pipelines -w
</code></pre></div> You can use <code>Ctrl+c</code> to terminate the watch</li> <li>A successful deployment of Tekton pipelines will show the following pods: <div class=highlight><pre><span></span><code>NAME                                         READY   STATUS    RESTARTS   AGE
tekton-pipelines-controller-9b8cccff-j6hvr   1/1     Running   0          2m33s
tekton-pipelines-webhook-6fc9d4d9b6-kpkp7    1/1     Running   0          2m33s
</code></pre></div></li> </ul> <h3 id=tekton-dashboard-installation-optional>Tekton Dashboard Installation (Optional)<a class=headerlink href=#tekton-dashboard-installation-optional title="Permanent link">&para;</a></h3> <ul> <li>To deploy the Tekton dashboard: <div class=highlight><pre><span></span><code>kubectl apply --filename https://github.com/tektoncd/dashboard/releases/download/latest/dashboard_latest_release.yaml
</code></pre></div></li> <li><strong><em>Note</em></strong>: It will take few mins for the Tekton dashboard components to be installed, you an watch the status using the command: <div class=highlight><pre><span></span><code>kubectl get pods -n tekton-pipelines -w
</code></pre></div> You can use <code>Ctrl+c</code> to terminate the watch</li> <li>A successful deployment of Tekton pipelines will show the following pods: <div class=highlight><pre><span></span><code>NAME                                           READY   STATUS    RESTARTS   AGE
tekton-dashboard-59c7fbf49f-79f7q              1/1     Running   0          50s
tekton-pipelines-controller-6b7f7cf7d8-r65ps   1/1     Running   0          15m
tekton-pipelines-webhook-7bbd8fcc45-sfgxs      1/1     Running   0          15m
</code></pre></div></li> <li>Access the dashboard as follows: <div class=highlight><pre><span></span><code>kubectl --namespace tekton-pipelines port-forward svc/tekton-dashboard <span class=m>9097</span>:9097
</code></pre></div> You can access the web UI at http://localhost:9097 .</li> </ul> <h2 id=create-target-namespace_1>Create Target Namespace<a class=headerlink href=#create-target-namespace_1 title="Permanent link">&para;</a></h2> <ul> <li>Set the environment variable <code>NAMESPACE</code> to <code>tekton-demo</code>, if you open a new terminal remember to set this environment again <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>NAMESPACE</span><span class=o>=</span>tekton-demo
</code></pre></div></li> <li>Create a the namespace using the variable <code>NAMESPACE</code> <div class=highlight><pre><span></span><code>kubectl create namespace <span class=nv>$NAMESPACE</span>
</code></pre></div></li> </ul> <h2 id=pipeline-resources_1>Pipeline Resources<a class=headerlink href=#pipeline-resources_1 title="Permanent link">&para;</a></h2> <h3 id=pipeline-resource-creation_1>Pipeline Resource Creation<a class=headerlink href=#pipeline-resource-creation_1 title="Permanent link">&para;</a></h3> <h4 id=create-a-pipelineresource-of-type-git_1>Create a PipelineResource of type <code>git</code><a class=headerlink href=#create-a-pipelineresource-of-type-git_1 title="Permanent link">&para;</a></h4> <ul> <li>Create the file <strong>git.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: <span class=nb>source</span>
spec:
  type: git
  params:
    - name: revision
      value: master
    - name: url
      value: https://github.com/ibm-cloud-architecture/cloudnative_sample_app
</code></pre></div> Verify the file content <div class=highlight><pre><span></span><code>cat git.yaml
</code></pre></div></li> </ul> <h4 id=create-a-pipelineresource-of-type-image_1>Create a PipelineResource of type <code>image</code><a class=headerlink href=#create-a-pipelineresource-of-type-image_1 title="Permanent link">&para;</a></h4> <ul> <li>Set the environment variable <code>DOCKER_USERNAME</code> to your dockerhub account, replace <code>&lt;REPLACEME&gt;</code> with your docker username, keep the quotes <div class=highlight><pre><span></span><code><span class=nb>export</span> <span class=nv>DOCKER_USERNAME</span><span class=o>=</span><span class=s1>&#39;&lt;REPLACEME&gt;&#39;</span>
</code></pre></div></li> <li>Create the file <strong>image.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: image
spec:
  type: image
  params:
    - name: url
      value: index.docker.io/<span class=nv>$DOCKER_USERNAME</span>/cloudnative_sample_app
</code></pre></div> Verify the file content, and make sure the <code>url</code> value is valid with your dockerhub username replaced <div class=highlight><pre><span></span><code>cat image.yaml
</code></pre></div></li> </ul> <h3 id=pipeline-resources-deployment_1>Pipeline Resources deployment<a class=headerlink href=#pipeline-resources-deployment_1 title="Permanent link">&para;</a></h3> <ul> <li>Each pipeline resource has:</li> <li><strong>name</strong>: the name using which it will be referred in other places</li> <li><strong>type</strong>: the type of the pipeline resource, in this example we have two types</li> <li><strong><em>git</em></strong> - this type of resource refers to a GitHub repository</li> <li><strong><em>image</em></strong> - this type of resource is linux container image</li> <li> <p><strong>params</strong>: each type can have one or more parameters that will be used to configure the underlying type. In the above example for the git-source pipeline resource, the parameters url and revision are used to identify the GitHub repository url and revision of the sources respectively.</p> </li> <li> <p>More details on other types of pipeline resource types is available <a href=https://github.com/tektoncd/pipeline/blob/master/docs/resources.md#resource-types>here</a>.</p> </li> <li> <p>Create the pipeline resources using the command: <div class=highlight><pre><span></span><code>kubectl apply -f git.yaml -n <span class=nv>$NAMESPACE</span>
kubectl apply -f image.yaml -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> </ul> <h3 id=verify-the-deployed-resource_1>Verify the deployed resource<a class=headerlink href=#verify-the-deployed-resource_1 title="Permanent link">&para;</a></h3> <ul> <li> <p>Use the Tekton cli to list the created resources <div class=highlight><pre><span></span><code>tkn res ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li> <p>The above command should list two resources as shown below: <div class=highlight><pre><span></span><code>NAME                        TYPE    DETAILS
source                      git     url: https://github.com/ibm-cloud-architecture/cloudnative_sample_app
image                       image   url: index.docker.io/yourdockerhubusername/cloudnative_sample_app
</code></pre></div> Use the command help via <code>tkn res --help</code></p> </li> <li>Use the Tekton cli to describe the git resource <div class=highlight><pre><span></span><code>tkn res describe <span class=nb>source</span> -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The output should look like this: <div class=highlight><pre><span></span><code>Name:                    source
Namespace:               tekton-demo
PipelineResource Type:   git

Params
NAME       VALUE
revision   master
url        https://github.com/ibm-cloud-architecture/cloudnative_sample_app

Secret Params
No secret params
</code></pre></div></li> <li>Use the Tekton cli to describe the git resource <div class=highlight><pre><span></span><code>tkn res describe image -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The output should look like this: <div class=highlight><pre><span></span><code>Name:                    image
Namespace:               tekton-demo
PipelineResource Type:   image

Params
NAME   VALUE
url    index.docker.io/myusername/cloudnative_sample_app

Secret Params
No secret params
</code></pre></div></li> </ul> <h2 id=tasks_1>Tasks<a class=headerlink href=#tasks_1 title="Permanent link">&para;</a></h2> <h3 id=task-creation_1>Task Creation<a class=headerlink href=#task-creation_1 title="Permanent link">&para;</a></h3> <ul> <li>Create the below yaml files.</li> <li>The following snippet shows what a Tekton Task YAML looks like:</li> <li> <p>Create the file <strong>test_task.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: java-test
spec:
  inputs:
    resources:
      - name: <span class=nb>source</span>
        type: git
    params:
      - name: maven-image
        type: string
        default: maven:3.3-jdk-8
  steps:
    - name: <span class=nb>test</span>
      image: <span class=k>$(</span>inputs.params.maven-image<span class=k>)</span>
      workingdir: <span class=k>$(</span>inputs.resources.source.path<span class=k>)</span>
      command: <span class=o>[</span><span class=s2>&quot;/bin/bash&quot;</span><span class=o>]</span>
      args:
        - -c
        - <span class=p>|</span>
          <span class=nb>set</span> -e
          mvn <span class=nb>test</span>
          <span class=nb>echo</span> <span class=s2>&quot;tests passed with rc=</span><span class=nv>$?</span><span class=s2>&quot;</span>
      volumeMounts:
        - name: m2-repository
          mountPath: /.m2
  volumes:
    - name: m2-repository
      emptyDir: <span class=o>{}</span>
</code></pre></div></p> </li> <li> <p>Each Task has the following:</p> </li> <li> <p><strong>name</strong> - the unique name using which the task can be referred</p> </li> <li><strong>inputs</strong> - the inputs to the task</li> <li><strong><em>resources</em></strong> - the pipeline resources that will be used in the task e.g. git-source</li> <li>name - the name of the input resource using which it can be referenced and bound via TaskRun</li> <li>type - the type of the input resource, typically the pipeline resource type</li> <li><strong><em>params</em></strong> - the parameters that will be used in the task steps. Each parameter has</li> <li>name - the name of the parameter</li> <li>description - the description of the parameter</li> <li> <p>default - the default value of parameter</p> </li> <li> <p><strong>Note</strong>: The <code>TaskRun</code> or <code>PipelineRun</code> could override the parameter values, if no parameter value is passed then the default value will be used.</p> </li> <li> <p><strong>outputs</strong> the pipeline resource that will end artifact of the task. In the above example the build will produce a container image artifact.</p> </li> <li><strong><em>resources</em></strong> - the pipeline resources that will be used in the task e.g. builtImage</li> <li>name - the name of the input resource using which it can be referenced and bound via TaskRun</li> <li>type - the type of the input resource, typically the pipeline resource type</li> <li><strong>steps</strong> - One or more sub-tasks that will be executed in the defined order. The step has all the attributes like a Pod spec</li> <li><strong>stepTemplate</strong> - when there is a need to have similar container configuration across all steps of a the task, we can have them defined in the stepTemplate, the task steps will inherit them implicitly in all steps. In the example above we define the resources and securityContext for all the steps</li> <li> <p><strong>volumes</strong> - the task can also mount external volumes using the volumes attribute.</p> </li> <li> <p>The parameters that were part of the spec inputs params can be used in the steps using the notation <code>$(&lt;variable-name&gt;)</code>.</p> </li> </ul> <h3 id=task-deploy_1>Task Deploy<a class=headerlink href=#task-deploy_1 title="Permanent link">&para;</a></h3> <ul> <li> <p>The application test task could be created using the command: <div class=highlight><pre><span></span><code>kubectl apply -f test_task.yaml -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li> <p>We will use the Tekton cli to inspect the created resources <div class=highlight><pre><span></span><code>tkn task ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div></p> </li> <li> <p>The above command should list one Task as shown below: <div class=highlight><pre><span></span><code>NAME        AGE
java-test   22 seconds ago
</code></pre></div></p> </li> </ul> <h3 id=taskrun_1>TaskRun<a class=headerlink href=#taskrun_1 title="Permanent link">&para;</a></h3> <ul> <li>The <a href=https://github.com/tektoncd/pipeline/blob/master/docs/taskruns.md>TaskRun</a> is used to run a specific task independently. In the following section we will run the build-app task created in the previous step</li> </ul> <h4 id=taskrun-creation_1>TaskRun Creation<a class=headerlink href=#taskrun-creation_1 title="Permanent link">&para;</a></h4> <ul> <li>The following snippet shows what a Tekton TaskRun YAML looks like:</li> <li>Create the file <strong>test_taskrun.yaml</strong> <div class=highlight><pre><span></span><code>apiVersion: tekton.dev/v1alpha1
kind: TaskRun
metadata:
  generateName: test-task-run-
spec:
  taskRef:
    name: java-test
  inputs:
    resources:
      - name: <span class=nb>source</span>
        resourceRef:
          name: <span class=nb>source</span>
</code></pre></div></li> <li><strong>generateName</strong> - since the TaskRun can be run many times, in order to have unique name across the TaskRun ( helpful when checking the TaskRun history) we use this generateName instead of name. When Kubernetes sees generateName it will generate unique set of characters and suffix the same to build-app-, similar to how pod names are generated</li> <li><strong>taskRef</strong> - this is used to refer to the Task by its name that will be run as part of this TaskRun. In this example we use build-app Task.</li> <li>As described in the earlier section that the Task inputs and outputs could be overridden via TaskRun.</li> <li>In this example we make the Task Run <code>spec &gt; inputs &gt; resources &gt; source</code> to refer to pipeline resource <code>source</code> via the <code>resourceRef</code>.</li> <li>The application test task(java-maven-test) could be run using the command: <div class=highlight><pre><span></span><code>kubectl create -n <span class=nv>$NAMESPACE</span> -f test_taskrun.yaml
</code></pre></div></li> <li><strong>Note</strong> - As tasks will use generated name, never use <code>kubectl apply -f test_taskrun.yaml</code></li> <li> <p>We will use the Tekton cli to inspect the created resources: <div class=highlight><pre><span></span><code>tkn tr ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The above command should list one TaskRun as shown below: <div class=highlight><pre><span></span><code>NAME                       STARTED        DURATION   STATUS
test-task-run-q6s8c        <span class=m>1</span> minute ago   ---        Running<span class=o>(</span>Pending<span class=o>)</span>
</code></pre></div> <strong>Note</strong> - It will take few seconds for the TaskRun to show status as Running as it needs to download the container images.</p> </li> <li> <p>To check the logs of the Task Run using the <code>tkn</code>:</p> </li> </ul> </div> </div> <p><div class=highlight><pre><span></span><code>tkn tr logs -f -a -n <span class=nv>$NAMESPACE</span>
</code></pre></div> <strong>Note</strong> - Each task step will be run within a container of its own. The -f or -a allows to tail the logs from all the containers of the task. For more options run <code>tkn tr logs --help</code> - If you see the TaskRun status as Failed or Error use the following command to check the reason for error: <div class=highlight><pre><span></span><code>tkn tr describe &lt;taskrun-name&gt; -n <span class=nv>$NAMESPACE</span>
</code></pre></div> - If it is successful, you will see something like below. <div class=highlight><pre><span></span><code>tkn tr ls -n <span class=nv>$NAMESPACE</span>
</code></pre></div> The above command should list one TaskRun as shown below: <div class=highlight><pre><span></span><code>NAME                  STARTED          DURATION     STATUS
test-task-run-q6s8c   <span class=m>47</span> seconds ago   <span class=m>34</span> seconds   Succeeded
</code></pre></div></p> <div class=highlight><pre><span></span><code>### Creating additional tasks and deploying them

- Create a Task to build a container image and push to the registry
- This task will be later used by the pipeline.
- Download the task file [task-buildah.yaml](/yamls/tekton-lab/task-buildah.yaml) to build the image, push the image to the registry:
- Create the `buildah` Task using the file and the command:
```bash
kubectl apply -f task-buildah.yaml -n $NAMESPACE
```
- Use the Tekton cli to inspect the created resources
```bash
tkn task ls -n $NAMESPACE
```
- The above command should list one Task as shown below:
```bash
NAME              AGE
buildah            4 seconds ago
java-test         46 minutes ago
```

- To access the docker registry, create the required secret as follows.
- Create the environment variables to be use, replace with real values and include the single quotes:
```bash
export DOCKER_USERNAME=&#39;&lt;DOCKER_USERNAME&gt;&#39;
```
```bash
export DOCKER_PASSWORD=&#39;&lt;DOCKER_PASSWORD&gt;&#39;
```
```bash
export DOCKER_EMAIL=&#39;&lt;DOCKER_EMAIL&gt;&#39;
```
- Run the following command to create a secret `regcred` in the namespace `NAMESPACE`
```bash
kubectl create secret docker-registry regcred \
  --docker-server=https://index.docker.io/v1/ \
  --docker-username=${DOCKER_USERNAME} \
  --docker-password=${DOCKER_PASSWORD} \
  --docker-email=${DOCKER_EMAIL} \
  -n ${NAMESPACE}
```
Before creating, replace the values as mentioned above.
Note: If your docker password contains special characters in it, please enclose the password in double quotes or place an escape character before each special character.

- (Optional) Only if you have problems with the credentials you can recreate it, but you have to deleted first
```bash
kubectl delete secret regcred -n $NAMESPACE
```
- Before we run the Task using TaskRun let us create the Kubernetes service account and attach the needed permissions to the service account, the following Kubernetes resource defines a service account called `pipeline` in namespace `$NAMESPACE` who will have administrative role within the `$NAMESPACE` namespace.
- Create the file **sa.yaml**
```bash
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pipeline
secrets:
  - name: regcred
```
- Create sa role as follows:
```bash
kubectl apply -n $NAMESPACE -f sa.yaml
```

- Lets create a Task Run for `buildah` Task using the `tkn` CLI passing the inputs, outputs and service account
```bash
tkn task start buildah \
  -i source=source \
  -i image=image \
  -s pipeline \
  -n $NAMESPACE
```
The task will start and logs will start printing automatically
```
Taskrun started: buildah-run-vvrg2
Waiting for logs to be available...
```

- Verify the status of the Task Run
```bash
tkn tr ls -n $NAMESPACE
```
Output should look like this
```
NAME                  STARTED          DURATION     STATUS
buildah-run-zbsrv      2 minutes ago    1 minute     Succeeded
```
- To clean up all Pods associated with all Task Runs, delete all the task runs resources
```bash
kubectl delete taskrun --all -n $NAMESPACE
```
- (Optional) Instead of starting the Task via `tkn task start` you could also use yaml TaskRun
```bash
apiVersion: tekton.dev/v1alpha1
kind: TaskRun
metadata:
  generateName: buildah-task-run-
spec:
  serviceAccountName: pipeline
  taskRef:
    name: buildah
  inputs:
    resources:
      - name: source
        resourceRef:
          name: source
      - name: image
        resourceRef:
          name: image
```
Then create the TaskRun with `generateName`
```bash
kubectl create -f taskrun.yaml -n $NAMESPACE
```
Follow the logs with:
```
tkn tr logs -f -n $NAMESPACE
```

## Pipelines

### Pipeline Creation

- Pipelines allows to start multiple Tasks, in parallel or in a [certain order](https://github.com/tektoncd/pipeline/blob/master/docs/pipelines.md#runafter)

- Create the file **pipeline.yaml**, the Pipeline contains two Tasks
```bash
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: test-build-push
spec:
  resources:
    - name: source
      type: git
    - name: image
      type: image
  tasks:
    - name: test
      taskRef:
        name: java-test
      resources:
        inputs:
          - name: source
            resource: source
    - name: build-push
      taskRef:
        name: buildah
      runAfter: [test]
      resources:
        inputs:
          - name: source
            resource: source
          - name: image
            resource: image
```

- Pipeline defines a list of Tasks to execute in order, while also indicating if any outputs should be used as inputs of a following Task by using the from field and also indicating the order of executing (using the runAfter and from fields). The same variable substitution you used in Tasks is also available in a Pipeline.
- Create the Pipeline using the command:
```bash
   kubectl apply -f pipeline.yaml -n $NAMESPACE
```
- Use the Tekton cli to inspect the created resources
```bash
   tkn pipeline ls -n $NAMESPACE
```
The above command should list one Pipeline as shown below:
```bash
   NAME              AGE              LAST RUN   STARTED   DURATION   STATUS
   test-build-push   31 seconds ago   ---        ---       ---        ---
```

### PipelineRun

#### PipelineRun Creation

- To execute the Tasks in the Pipeline, you must create a PipelineRun. Creation of a PipelineRun will trigger the creation of TaskRuns for each Task in your pipeline.
- Create the file **pipelinerun.yaml**
```bash
apiVersion: tekton.dev/v1alpha1
kind: PipelineRun
metadata:
  generateName: test-build-push-run-
spec:
  serviceAccountName: pipeline
  pipelineRef:
    name: test-build-push
  serviceAccountName: pipeline
  resources:
    - name: source
      resourceRef:
        name: source
    - name: image
      resourceRef:
        name: image
```
**serviceAccount** - it is always recommended to have a service account associated with PipelineRun, which can then be used to define fine grained roles.
- Create the PipelineRun using the command:
```bash
kubectl create -f pipelinerun.yaml -n $NAMESPACE
```
- We will use the Tekton cli to inspect the created resources
```bash
tkn pipelinerun ls -n $NAMESPACE
```

- The above command should list one PipelineRun as shown below:
```bash
NAME                        STARTED         DURATION   STATUS
test-build-push-run-c7zgv   8 seconds ago   ---        Running
```

- Wait for few minutes for your pipeline to complete all the tasks. If it is successful, you will see something like below.
```bash
tkn pipeline ls -n $NAMESPACE
```
```
NAME              AGE              LAST RUN                    STARTED         DURATION    STATUS
test-build-push   33 minutes ago   test-build-push-run-c7zgv   2 minutes ago   2 minutes   Succeeded
```
- Run again the pipeline ls command
```bash
tkn pipelinerun ls -n $NAMESPACE
```
```
NAME                        STARTED         DURATION    STATUS
test-build-push-run-c7zgv   2 minutes ago   2 minutes   Succeeded
```
If it is successful, go to your container registry account and verify if you have the `cloudnative_sample_app` image pushed.

- (Optional) Run the pipeline again using the `tkn` CLI
```bash
tkn pipeline start test-build-push \
  -r source=source \
  -r image=image \
  -s pipeline \
  -n $NAMESPACE
```
- (Optional) Re-run the pipeline using last pipelinerun values
```bash
tkn pipeline start test-build-push --last -n $NAMESPACE
```

## Deploy Application

- Deploy the app as follows:
```bash
export APP_YAML_URL=&#39;https://raw.githubusercontent.com/ibm-cloud-architecture/cloudnative_sample_app_deploy/master/yamls/&#39;
kubectl apply -n $NAMESPACE -f $APP_YAML_URL/deployment.yaml
kubectl apply -n $NAMESPACE -f $APP_YAML_URL/service.yaml
```
- Replace the default image with the new image you deployed using Tekton
- Replace `&lt;DOCKER_USERNAME&gt;` with your username
```bash
export DOCKER_USERNAME=&#39;&lt;DOCKER_USERNAME&gt;&#39;
```
- Replace `&lt;SHORT_GIT_HASH&gt;` with the tag of the image you push to the registry, you can go the registry Web UI and verify the tag value.
```bash
export SHORT_GIT_HASH=&#39;&lt;SHORT_GIT_HASH&gt;&#39;
```
- Set the environment variable `IMAGE_URL` to the new image url value sing the two previous environment variables `DOCKER_USERNAME` and `SHORT_GIT_HASH`
```bash
export IMAGE_URL=docker.io/${DOCKER_USERNAME}/cloudnative_sample_app:${SHORT_GIT_HASH}
echo $IMAGE_URL
```
- Replace the image on the deployment
```bash
kubectl set image \
  deployment/cloudnativesampleapp-deployment \
  \*=${IMAGE_URL} \
  -n $NAMESPACE --record
```
- Verify the image is set
```bash
kubectl get deploy \
  cloudnativesampleapp-deployment \
  -o jsonpath=&#39;{.spec.template.spec.containers[0].image}&#39; \
  -n $NAMESPACE
```
- Verify if the pods are running:
```bash
kubectl get pods -n $NAMESPACE -l app=cloudnativesampleapp-selector
```
```
NAME                          READY   STATUS      RESTARTS   AGE
cloudnativesampleapp...       1/1     Running     0          82s
```
- Retrieve the service NodePort:
```bash
kubectl describe svc cloudnativesampleapp-service -n $NAMESPACE | grep NodePort
```
```
Type:                     NodePort
NodePort:                 http  30632/TCP
```
In this instance the NodePort assigned is `30632`
- Get the External Public IP as follows:
```bash
minikube ip
```
```
192.168.64.30
```
- Now access the compose the URL of the App using IP and NodePort
```bash
export APP_EXTERNAL_IP=$(minikube ip)
export APP_NODEPORT=$(kubectl get svc cloudnativesampleapp-service -n $NAMESPACE -o jsonpath=&#39;{.spec.ports[0].nodePort}&#39;)
export APP_URL=&quot;http://${APP_EXTERNAL_IP}:${APP_NODEPORT}/greeting?name=Carlos&quot;
echo $APP_URL
```
```
http://192.168.64.30:30632//greeting?name=Carlos
```
- Now access the app from terminal or browser
```bash
curl $APP_URL
```
```bash
open $APP_URL
```
</code></pre></div> </article> </div> </div> </main> <!-- Footer --> <footer class=md-footer> <!-- Further information --> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-column> <div class=md-footer-text><a href=https://develop.cloudnativetoolkit.dev/contribute/contribute/ >Contribute</a> to the Cloud-Native Toolkit</div> <div class=md-footer-text>Site licensed under <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ >CC BY-NC-SA 4.0</a></div> </div> <div class=md-footer-column> <div class=md-footer-text>Have questions? open an issue on <a href=https://github.com/cloud-native-toolkit/planning/issues/new/choose>GitHub</a>.</div> <!-- Copyright and theme information --> <div class=md-footer-text> Copyright  2022 IBM </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.b0710199.min.js", "version": null}</script> <script src=../../assets/javascripts/bundle.76f349be.min.js></script> </body> </html>